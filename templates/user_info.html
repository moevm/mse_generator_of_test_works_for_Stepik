<html>
<head>
    <meta charset="utf-8">
    <title>Страница пользователя</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user_info.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>
<body>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<div id="id01" class="w3-modal">
    <div class="w3-modal-content">
      <div class="w3-container">
        <span onclick="document.getElementById('id01').style.display='none'" class="w3-button w3-display-topright">&times;</span>
          <p id="course-date"></p>
          <p>Обновить курс?</p>
          <button id="yes-btn">Да</button>
          <button id="no-btn">Нет</button>
      </div>
    </div>
</div>
<div class="user-page">
    <div class="form">
        <form class="user-form" action="{{ url_for('course') }}" method="GET">
            <div class="logout-button">
                <a href={{ url_for('logout') }}>
                    <img id="logout" src="../static/icons/logout_icon.png" width="48px" height="48px">
                </a>
            </div>
            <div class="user-name">
                <h4>
                    Hello,
                </h4>
                <h3 name="user_name">
                    {{ name }}
                </h3>
            </div>
            <div class="input-group mb-3" id="course-selection">
                <select name="id" class="custom-select" id="inputGroupSelect02">
                    <option selected value="">Choose...</option>
                    {% for course in courses %}
                        <option value="{{ course['id'] }}">{{ course['title'] }}</title></option>
                    {% endfor %}
                </select>
                <div class="input-group-append">
                    <label class="input-group-text" for="inputGroupSelect02">Courses</label>
                </div>
                <div id="buttons">
                    <button type="submit" id="select-button">Генерация контрольной</button>
                    <button id="select-button2">Учебный план</button>
                </div>
            </div>
        </form>
    </div>
</div>
<script>
    $(document).ready(function(){
        $('#select-button2').on('click', function () {
            if (checkCourseLoad()) {
                $.get(`plan?id=${$('#inputGroupSelect02').val()}&download=false`);
            }
        });

        $(".user-form").submit(function(e) {
            if (checkCourseLoad()) {
                e.preventDefault();
            }
        });

        $("#yes-btn").on('click', function () {
            sendGETtoCourse(true)
        });

        $("#no-btn").on('click', function () {
            sendGETtoCourse(false)
        });

        function sendGETtoCourse(download) {
            $.ajax({
                url: `course?id=${$('#inputGroupSelect02').val()}&download=${download}`,
                type: 'GET',
                error: function () {
                    alert('GET course error');
                },
            });
        }

        function checkCourseLoad() {
            let isLoaded = false;
            $.ajax({
                url: `check?id=${$('#inputGroupSelect02').val()}`,
                type: 'GET',
                success: function (data) {
                    if (data.isSave) {
                        isLoaded = true;
                        $('#course-date').val('Курс был скачен: ' + new Date(data.createDate).toLocaleDateString());
                        document.getElementById('id01').style.display='block';
                    }
                },
                error: function () {
                    alert('check error');
                },
            });
            return isLoaded;
        }
    });
</script>
</body>
</html>